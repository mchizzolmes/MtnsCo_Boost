{% comment %}
Dynamic Product Detail Section - Liquid Logic Only
Styles are handled separately to avoid theme update conflicts
{% endcomment %}

{% assign mountain_handle = product.handle | split: '-' | first %}
{% assign mountain_info = shop.metaobjects.mountain-info[mountain_handle] %}

{% if mountain_info and section.settings.show_mountain_story %}
  {% assign description = mountain_info.description.value %}
  {% assign images = mountain_info.images.value %}
  {% assign mountain_name = mountain_info.mountain_name.value %}
  
  {% comment %} Calculate layout variables {% endcomment %}
  {% assign word_count = description | strip_html | split: ' ' | size %}
  {% assign image_count = images.size | at_most: section.settings.max_images %}
  {% assign layout_seed = mountain_name | size | modulo: 4 %}

  <section class="product-detail" data-layout="{{ layout_seed }}">
    <div class="product-detail__container">
      
      <header class="product-detail__header">
        <h2 class="product-detail__title">{{ mountain_name }}</h2>
        <div class="product-detail__divider"></div>
      </header>

      <div class="product-detail__grid" 
           data-images="{{ image_count }}" 
           data-words="{{ word_count }}"
           data-style="{{ section.settings.layout_style }}">
        
        {% assign paragraphs = description | split: '</p>' %}
        {% assign total_blocks = paragraphs.size | plus: image_count %}
        
        {% assign text_index = 0 %}
        {% assign image_index = 0 %}
        
        {% for i in (1..total_blocks) %}
          {% assign should_show_image = false %}
          
          {% if image_index < image_count %}
            {% case layout_seed %}
              {% when 0 %}
                {% assign remainder = i | modulo: 3 %}
                {% if remainder == 0 %}
                  {% assign should_show_image = true %}
                {% endif %}
              {% when 1 %}
                {% assign remainder = i | modulo: 2 %}
                {% if remainder == 0 %}
                  {% assign should_show_image = true %}
                {% endif %}
              {% when 2 %}
                {% if i == 2 or i == total_blocks %}
                  {% assign should_show_image = true %}
                {% endif %}
              {% else %}
                {% assign remainder = i | modulo: 4 %}
                {% if remainder == 1 %}
                  {% assign should_show_image = true %}
                {% endif %}
            {% endcase %}
          {% endif %}
          
          {% if should_show_image and image_index < image_count %}
            <div class="content-block content-block--image" data-position="{{ i }}">
              <figure class="image-wrapper">
                <img src="{{ images[image_index] | image_url: width: 600 }}" 
                     alt="{{ mountain_name }}"
                     loading="lazy"
                     class="responsive-image">
              </figure>
            </div>
            {% assign image_index = image_index | plus: 1 %}
            
          {% elsif text_index < paragraphs.size %}
            {% unless paragraphs[text_index] == blank %}
              <div class="content-block content-block--text" data-position="{{ i }}">
                <div class="text-content">
                  {{ paragraphs[text_index] }}{% unless paragraphs[text_index] contains '</p>' %}</p>{% endunless %}
                </div>
              </div>
            {% endunless %}
            {% assign text_index = text_index | plus: 1 %}
          {% endif %}
        {% endfor %}
        
      </div>
    </div>
  </section>

{% endif %}

{% schema %}
{
  "name": "Product Detail",
  "settings": [
    {
      "type": "checkbox",
      "id": "show_mountain_story",
      "label": "Show Mountain Story",
      "default": true
    },
    {
      "type": "range",
      "id": "max_images",
      "min": 1,
      "max": 6,
      "step": 1,
      "label": "Maximum Images",
      "default": 4
    },
    {
      "type": "select",
      "id": "layout_style",
      "label": "Layout Style",
      "options": [
        {"value": "auto", "label": "Auto (Dynamic)"},
        {"value": "masonry", "label": "Masonry"},
        {"value": "magazine", "label": "Magazine"}
      ],
      "default": "auto"
    }
  ]
}
{% endschema %}